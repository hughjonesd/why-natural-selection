---
title: "Negative Selection in the 20th Century"
author: "David Hugh-Jones, Abdel Abdellaoui"
date: "April 2020"
output: 
  bookdown::pdf_document2:
    toc: false
    latex_engine: xelatex
---


```{r setup, include = FALSE}

library(drake)
library(magrittr)
library(dplyr)
library(forcats)
library(ggplot2)
library(tidyr)
library(santoku) # keep this after tidyr as it masks chop
library(purrr)
library(glue)
library(broom)
library(huxtable)


drake::loadd(rgs)
drake::loadd(score_names)
drake::loadd(famhist)

options(digits = 2)
options(dplyr.summarise.inform = FALSE) # shut up about summarize
knitr::opts_chunk$set(
        echo = FALSE, 
        warning = FALSE, 
        cache = FALSE, 
        error = TRUE,
        fig.height = 3.5
      )

huxtable::set_default_properties(latex_float = "h!")

theme_set(theme_minimal())
my_hline <- geom_hline(yintercept = 0, colour = "grey20", linetype = "dotted")
my_vline <- geom_vline(xintercept = 0, colour = "grey20", linetype = "dotted")
pval_palette <- c("FALSE" = "grey65", "TRUE" = "#FAC32D")


standard_ggplot <- function (
        dfr, 
        fill_col, 
        n_regs, 
        ...,
        score_col = quo(term), 
        order_idx = 1, 
        n_cats    = NULL
      ) {
  if (! missing(score_col)) score_col <- enquo(score_col)
  fill_col <- if (! missing(fill_col)) enquo(fill_col) else quo(NULL)
  if (missing(n_cats)) {
    n_cats <- if (missing(fill_col)) 1 else length(unique(pull(dfr, 
                {{fill_col}})))
  }
  
  n_regs <- as.double(n_regs)
  
  dfr %>% mutate(
          !! score_col := pretty_names(!! score_col),
          !! score_col := fct_reorder(!! score_col, estimate, order_abs(order_idx))
        ) %>% 
        ggplot(aes(estimate, {{score_col}}, fill = {{fill_col}}, ...,
          colour = p.value < 0.05/{{n_regs}})) +
          pval_geom_point() +
          my_vline + 
          pval_scale() +
          my_fill_scale(n = n_cats) +
          my_labs() +
          my_theme()
}


my_theme <- function (...) theme(axis.text.y = element_text(size = 7), ...)


pval_scale <- function (...) scale_color_manual(values = pval_palette, ...)


pval_geom_point <- function (size = 1.5, stroke = 0.7, ...) {
  geom_point(shape = 21, size = size, stroke = stroke, ...)
}


my_fill_scale <- function (n, aesthetics = "fill", ...) {
  if (n == 2) {
    scale_colour_manual(values = c("steelblue4", "#D63C3C"), 
          aesthetics = aesthetics, ...)
    # scale_color_brewer(type = "qual", palette = 3, aesthetics = aesthetics, ...)
  } else {
    scale_color_brewer(aesthetics = aesthetics, ...)
  }
}


my_labs <- function (x = "Effect size", y = "", ...) labs(x = x, y = y, ...)


# for use when reordering factors. Order by the nth score in a group
order_abs <- function (n = 1) {
  function (x) x[n] 
}


pretty_names <- function (names) {
  pretty <- c(
    ADHD_2017               = "ADHD",
    age_at_menarche         = "Age at menarche",
    age_at_menopauze        = "Age at menopause",
    agreeableness           = "Agreeableness",
    ai_substance_use        = "Age at smoking initiation",
    alcohol_schumann        = "Alcohol use",
    alzheimer               = "Alzheimer",
    autism_2017             = "Autism",
    bipolar                 = "Bipolar",
    bmi_combined            = "BMI",
    body_fat                = "Body Fat",
    caffeine                = "Caffeine",
    cannabis                = "Cannabis (ever vs. never)",
    cognitive_ability       = "Cognitive Ability",
    conscientiousness       = "Conscientiousness",
    coronary_artery_disease = "Coronary Artery Disease",
    cpd_substance_use       = "Cigarettes per day",
    diagram_T2D             = "Type 2 Diabetes",
    dpw_substance_use       = "Drinks per week",
    EA2_noUKB               = "Educ. attainment 2 (no UK)",
    EA3_excl_23andMe_UK     = "Educ. attainment 3 (no UK)",
    eating_disorder         = "Eating disorder",
    extraversion            = "Extraversion",
    height_combined         = "Height",
    hip_combined            = "Hip circumference",
    MDD_PGC2_noUKB          = "Major Depressive Disorder",
    neuroticism             = "Neuroticism",
    openness                = "Openness",
    sc_substance_use        = "Smoking cessation",
    SCZ2                    = "Schizophrenia",
    si_substance_use        = "Smoking initiation",
    wc_combined             = "Waist circumference",
    whr_combined            = "Waist-hip ratio"
  )
  
  pretty[names]
}


n_in_regs <- function (var, dv = "n_children") {
  # all PGS have the same NA pattern, so we just use one
  tbl <- table(famhist[
                  ! is.na(famhist[dv]) & ! is.na(famhist$whr_combined), 
                  var
                ])
  c(tbl)
}


add_n <- function (var, famhist_var = var, dv = "n_children") {
  var <- as.factor(var)
  n <- n_in_regs(famhist_var, dv)
  levels(var) <- sprintf("%s (N = %s)", levels(var), 
                         prettyNum(n[levels(var)], big.mark = ","))
  # var_n <- sprintf("%s (N = %s)", var, prettyNum(n[var], big.mark = ","))
  # var_n[is.na(var)] <- NA
  var
}


# from https://github.com/dgrtwo/drlib/blob/master/R/reorder_within.R
# for ordering within facets
reorder_within <- function(x, by, within, fun = mean, sep = "___", ...) {
  new_x <- paste(x, within, sep = sep)
  stats::reorder(new_x, by, FUN = fun)
}


scale_x_reordered <- function(..., sep = "___") {
  reg <- paste0(sep, ".+$")
  ggplot2::scale_x_discrete(labels = function(x) gsub(reg, "", x), ...)
}

scale_y_reordered <- function(..., sep = "___") {
  reg <- paste0(sep, ".+$")
  ggplot2::scale_y_discrete(labels = function(x) gsub(reg, "", x), ...)
}

```

# Introduction

Existing work suggests that natural selection is taking place in modern populations,
but that effect sizes are small. In this paper we investigate natural selection
in the UK over the twentieth century, using data from UK Biobank. We use
questions on number of children and number of siblings to reconstruct two
generations of family size per respondent. We then relate these to polygenic
scores for several different characteristics. 

Natural selection is taking place on most polygenic scores, and is broadly
"negative" in that characteristics that most people would consider undesirable
are being selected for. Effect sizes are larger for number of siblings than for
number of children. This is not because the strength of natural selection has
changed over time. Instead, the difference is probably due to ascertainment bias
in UK Biobank. Indeed, natural selection is concentrated among population
subgroups that are under-represented in the sample, including less-educated
people and poorer households. When we weight the sample to correct for
ascertainment bias, many effect sizes are considerably larger.

Among mothers who were older at first birth, and among parents with fewer sexual
partners, effect signs are reversed. The effects of PGS can be decomposed into
two channels: an effect on age at first live birth, and an opposite-signed
effect on number of children conditional on age at first live birth. This
pattern may be explained by economic theories of fertility. In these, higher
potential earnings have two opposite effects on fertility: a
fertility-increasing income effect (higher income makes children more
affordable), and a fertility-lowering substitution effect (time spent on
childrearing has a higher cost in foregone earnings). Among couples who can take
advantage of coordination in childcare activities, the income effect dominates;
among single parents, or those in unstable relationships, the substitution effect
dominates.

# Open questions/TODO

* If we weight with the GHS, and plot the means of figure 1 using this w
  weighting, most things stay the same - but the change in EA is reversed! EA
  increases over time. Could this be because the sample includes many
  relatively educated older people? If so, then mean effects are *overestimated*
  by figure 1. 
* Need to make the weighting very watertight. 
  - Include income? 
  - Interact age and other variables?
  - Investigate "MRP" (Gelman 2005)
  - Understand reweighting on subsets of survey data.
  - Check for existing work
  - Chris Hanretty suggested using 2011 census. Household size/type would also
    be good.
* Reweight other regressions (e.g. the omnibus regression in the appendix)
* Could be useful: f.2139 - age first had sex (includes "never had sex" 
  which may explain some of the many NAs for f.2141, num sex partners)
*  Need f.6138 to correctly calculate `age_fulltime_edu` including
  those who went to college.
* Look at geography, esp. in siblings regressions.
* control for age in n_partners regressions.


# Data

Data is taken from UK Biobank. Polygenic scores were  normalized to mean 0,
variance 1. 

# Results

Figure \@ref(fig:plot-means-over-time) plots mean polygenic scores by 5-year
birth intervals, for the entire sample. Several scores show consistent increases
or declines over this 30-year period, of the order of 5% of a standard deviation.


```{r calc-means-over-time}

drake::loadd(famhist)
drake::loadd(ghs_weights)
famhist <- left_join(famhist, ghs_weights, by = "f.eid")
pgs_over_time <- famhist %>% 
      group_by(
        YOB = santoku::chop(YOB, 
          seq(1940, 1970, 5), 
          labels    = seq(40, 65, 5),
          extend    = FALSE
        ) 
      ) %>% 
      filter(! is.na(YOB)) %>% 
      summarize(across(all_of(score_names), ggplot2::mean_cl_normal, na.rm = TRUE)) %>% 
      pivot_longer(-YOB, names_to = "score_name", values_to = "score") %>% 
      mutate(
        score_lo = score$ymin,
        score_hi = score$ymax,
        score    = score$y
      )
 
```


```{r plot-means-over-time, fig.height = 5, fig.cap = "Mean polygenic scores by birth year in UK Biobank. Points are means for 5-year intervals. Lines are 95% confidence intervals."}

pgs_over_time %>% 
      mutate(score_name = pretty_names(score_name)) %>% 
      ggplot(aes(YOB, group = score_name)) + 
      geom_pointrange(aes(ymin = score_lo, y = score, ymax = score_hi), 
        colour = "steelblue4", fatten = 2) +
      facet_wrap(~score_name) +
      my_hline +
      theme(
        strip.text  = element_text(size = 6), 
        axis.text.x = element_text(size = 7)
      ) +
      labs(y = "PGS", x = "Birth year (5 year intervals)")

```

We run bivariate regressions on two dependent variables:

* *siblings*, the number of full siblings in the respondent's sib (including
  himself or herself).
* The number of *children* ever born to/fathered by the respondent.


```{r calc-regs-all}

drake::loadd(res_all)

res_all_wide <- res_all %>% 
  filter(reg.type == "raw") %>% 
  select(dep.var, term, estimate) %>% 
  pivot_wider(names_from = dep.var, values_from = estimate)

n_pgs  <- as.double(nrow(res_all_wide))

prop_gens <- res_all_wide[["N siblings"]]/res_all_wide[["N children"]]
median_prop_gens <- median(prop_gens[prop_gens > 0])
```


Figure \@ref(fig:plot-basic-regs) shows effect sizes of a one-standard
deviation shift in each polygenic score. 

Estimates are broadly consistent across generations. However, effect sizes are 
much larger for *siblings* than for *children* 
regressions. Among consistently-signed estimates, at the median, the proportion between
effect sizes for siblings and for children is `r 100 * median_prop_gens` per cent.


```{r plot-basic-regs, fig.cap = "Effects of polygenic scores on number of siblings/children."}

drake::loadd(res_all)

n_regs <- as.double(nrow(res_all))
res_all %>% 
      filter(reg.type == "raw") %>% 
      mutate(
        term    = pretty_names(term),
        term    = fct_reorder(term, estimate, order_abs(1)),
        dep.var = fct_inorder(dep.var) 
      ) %>% 
      ggplot(aes(y = term, x = estimate, fill = dep.var, 
        colour = p.value < 0.05/{{n_regs}})) +
      my_vline + 
      pval_geom_point() +
      my_labs() +
      pval_scale() +
      my_fill_scale(n = 2, guide = guide_legend(title = "")) +
      my_theme()

```


# Subgroups

We next examine how different subgroups of the population contribute to natural 
selection. These analyses have two goals: to get a sense of how ascertainment bias
could affect our basic results, and to learn more about the causes of natural 
selection in the UK population. Because we have more data on respondents than on
their parents, we focus on *children* regressions.


## Sex, income and education

Figure \@ref(fig:plot-sexes) shows effect sizes of PGS on number of children
separately for males and females. Differences are particularly large for
educational attainment, height and MDD. There is no overall pattern in
differences of effect size, however.


```{r plot-sexes, fig.cap = "Effect sizes on number of children by sex. Lines show significant differences"}

drake::loadd(res_sex)
n_regs <- as.double(nrow(res_sex))

res_sex_wide <- res_sex %>% 
      select(term, estimate, sex, diff.p.value) %>% 
      pivot_wider(names_from = "sex", values_from = "estimate") %>% 
      mutate(
        min_est = pmin(Female, Male),
        max_est = pmax(Female, Male),
        term = pretty_names(term),
        term = fct_reorder(term, Female)
      ) 
  

res_sex %>% 
      mutate(
        term = pretty_names(term),
      ) %>% 
      ggplot(aes(y = term, x = estimate, fill = sex, 
            colour = p.value < 0.05/{{n_regs}})) +
        my_vline +
        geom_linerange(data = res_sex_wide, 
          aes(
            y      = term,
            x      = NULL,
            fill   = NULL,
            xmin   = min_est, 
            xmax   = max_est, 
            colour = diff.p.value < 0.05/{{n_regs}}
          ), 
        group = "") +
        pval_geom_point() +
        pval_scale() +
        my_fill_scale(n = 2) +
        my_labs() +
        my_theme()

```


Figure \@ref(fig:plot-educ-level) splits respondents up by education levels.
Selection effects are typically larger and more significant for those who left
school before 16.  Figure \@ref(fig:plot-income) splits respondents by household
income category. A very similar pattern holds, with selection effects being
larger for those in the poorest income category.


```{r plot-educ-level, fig.cap = "Effect sizes on number of children by age left full-time education"}

drake::loadd(res_edu)
n_regs <- as.double(nrow(res_edu))


res_edu %>% 
      mutate(
        term = pretty_names(term), 
        term = fct_reorder(term, estimate, order_abs(1)),
        "Age left FTE" = fct_relevel(age_fte_cat, "< 16", "16-18", "> 18"),
        "Age left FTE" = add_n(`Age left FTE`, "age_fte_cat")
      ) %>% 
      ggplot(aes(y = term, x = estimate, colour = p.value < 0.05/{{n_regs}}, 
        fill = `Age left FTE`)) +
        my_vline +
        pval_geom_point() + 
        pval_scale() +
        my_fill_scale(n = 3, direction = -1) +
        my_labs() +
        my_theme()
        
```



```{r plot-income, fig.cap = "Effect sizes on number of children by household income"}

drake::loadd(res_income)

n_regs <- as.double(nrow(res_income))
res_income %>% 
      mutate(
        term = pretty_names(term), 
        term = fct_reorder(term, estimate, order_abs(1)),
        Income = factor(income_cat, 
          labels = c("< £18K", "£18-30K", "£31-51K", "£52-100K", "> £100K")
        ),
        Income = add_n(Income, "income_cat")
      ) %>% 
      ggplot(aes(y = term, x = estimate, fill = Income, 
        colour = p.value < 0.05/{{n_regs}})) +
        my_vline +
        pval_geom_point(alpha = 0.8) + 
        my_fill_scale(n = 5, direction = -1) +
        pval_scale() +
        my_labs() +
        my_theme()
```


```{r calc-income-edu-controlled}
drake::loadd(res_income_controlled, res_edu_controlled)
n_regs_ic <- nrow(res_income_controlled)
n_sig_ic <- sum(res_income_controlled$p.value < 0.05/n_regs_ic)

n_regs_educ <- nrow(res_edu_controlled)
n_sig_educ <- sum(res_edu_controlled$p.value < 0.05/n_regs_educ)
```


These results could be driven by age, if older respondents are poorer and less
educated, and also more subject to selection on polygenic scores. However, if we
rerun the regressions, interacting the polygenic score with income category and
also with a quadratic in age, the interaction with income remains significant at
0.05/`r n_regs_ic` for `r n_sig_ic` out of `r n_regs_ic` regressions. Similarly
if we interact the PGS with age of leaving full time education and a quadratic
in age, the interaction with age leaving FTE remains significant at 
0.05/`r n_regs_educ` for `r n_sig_educ` out of `r n_regs_educ` regressions.


The UK Biobank sample overrepresents highly educated people and high-income
households. This suggests that statistics from the sample may underestimate
the level of natural selection in the population.

## Age at first live birth


```{r calc-age-flb-cross}

drake::loadd(res_age_flb_cross)

cor_age_flb <- res_age_flb_cross %>% 
      mutate(category = gsub(":.*", "", term)) %>% 
      pivot_wider(score_name, names_from = category, values_from = estimate) %>%              {cor(.$`age_flb_cat10-22`, .$`age_flb_cat28-52`)}

```


Age at first live birth correlates with number of children ever born. Figure
\@ref(fig:plot-age-flb-cross) shows *children* regressions estimated separately
for each tercile of age at first live birth. Several effects are strikingly
different across terciles. ADHD and MDD are selected for amongst the youngest
third of mothers, but selected against among the oldest two-thirds. Educational
attainment is selected for among the oldest two-thirds of mothers, but is not
significantly selected among the youngest third. Similarly, several PGS of body
measurements are selected against only among older mothers. The correlation
between effect sizes for the youngest and oldest terciles is `r cor_age_flb`.
This is the first sign that selection may work in different directions across
different subgroups.

Figure \@ref(fig:plot-n-partners) splits males and females by lifetime number of
sexual partners, at the median value of 3. Again, selection effects are reversed
across the groups. Among men and women with more than 3 sexual partners, for
example, EA is selected against; among those with 3 or fewer sexual partners, it
is selected for. Selection is broadly negative (positive) among those 
with more (less) partners.

Lastly Figure \@ref(fig:plot-with-partner) splits respondents up by whether they
were living with a spouse or partner at the time of interview. Effects are 
generally the same sign in both groups, but are much larger among those not
living with a spouse or partner.


```{r plot-age-flb-cross, fig.cap = "Effect sizes on number of children, by age at first live birth terciles"}

drake::loadd(res_age_flb_cross)

# this counts each cross term as a separate test:
n_regs <- as.double(nrow(res_age_flb_cross)) 

res_age_flb_cross %>% 
      mutate(
        score_name = pretty_names(score_name),
        score_name = fct_reorder(score_name, estimate, order_abs(1)),
        term       = gsub("age_flb_cat(.*):.*", "\\1", term),
        term       = add_n(term, "age_flb_cat")
      ) %>% 
      ggplot(aes(estimate, score_name, fill = term, 
        colour = p.value < 0.05/{{n_regs}})) +
        my_vline +
        pval_geom_point() +
        pval_scale() +
        my_fill_scale(n = 3, direction = -1, 
          guide = guide_legend(title = "Age at first live birth")) +
        my_labs() +
        my_theme()


```


```{r plot-n-partners, fig.cap = "Effect sizes on number of children by number of sexual partners", fig.height = 4}


drake::loadd(res_partners)
res_partners %<>%       
      filter(term != "(Intercept)", term != "lo_partnersTRUE") %>% 
      mutate(`N partners` = ifelse(grepl(":", term), "<= 3", "> 3")) 


n_regs <- as.double(nrow(res_partners))
res_partners %>% 
      mutate(
        score_name = pretty_names(score_name)
      ) %>% 
      ggplot(aes(
        y      = reorder_within(score_name, estimate, sex, fun = order_abs(1)), 
        x      = estimate, 
        fill   = `N partners`, 
        colour = p.value < 0.05/{{n_regs}}
      )) + 
        my_vline +
        pval_geom_point() +
        facet_wrap(vars(sex), scales = "free_y") +
        my_fill_scale(n = 2) +
        pval_scale() +
        my_theme(legend.position = "bottom") +
        my_labs(x = "", y = "") + 
        scale_y_reordered()

```


```{r plot-with-partner, fig.cap = "Effect sizes on number of children by household type"}

drake::loadd(res_with_partner)
res_with_partner %<>% filter(grepl(":", term)) 

n_regs <- nrow(res_with_partner)
hhtype_n <- n_in_regs("with_partner")

res_with_partner %>% 
      mutate(
        Household = ifelse(grepl("TRUE", term), "With partner", 
                      "Without partner"),
        with_p    = as.character(grepl("TRUE", term)),
        Household = sprintf("%s (N = %s)", Household, 
                      prettyNum(hhtype_n[with_p], big.mark = ","))
      ) %>% 
      standard_ggplot(fill = Household, n_regs = n_regs, score_col = score_name)
```


# Accounting for ascertainment bias

Our results are subject to two kinds of ascertainment bias. First, Biobank is
not a random sample of the UK population: for example, it overrepresents
educated people and high income households. Second, sampling parents of
respondents inherently overweights parents who have many children. For instance,
parents of three children will have three times more children as respondents in
UK Biobank than parents of one child, on average. Parents of no children will,
by definition, not be represented at all.


```{r calc-res-weighted}

drake::loadd(res_weighted)
drake::loadd(res_sibs_parent_weights)
drake::loadd(res_all)
res_weighted_all <- bind_rows(
        "N children" = res_weighted, 
        "N siblings" = res_sibs_parent_weights, 
      .id = "dep.var") 
res_weighted_all$reg.type <- "weighted"
res_weighted_all <- bind_rows(
        res_weighted_all,
        res_all %>% filter(reg.type == "raw") %>% select(-score_name)
      )

res_wide <- full_join(
        res_weighted,
        res_sibs_parent_weights,
        by = "term",
        suffix = c(".children", ".sibs")
      ) %>% 
      filter(p.value.children < 0.05/33 | p.value.sibs < 0.05/33) 

chn_larger <- with(res_wide, estimate.children > estimate.sibs)

```


To compensate for ascertainment bias in the UK Biobank sample, we weight participants
by sex, age (within the 40-71 age group), and education. Our sample weights are
calibrated based on the 2006 General Household Survey. We then calculate the 
proportions of respondents within each sibling group size, based on the respondent
weights, and use this to create weights for the sibling regressions.

We rerun the basic regressions for both children and siblings, using the new
weights. Figure \@ref(fig:plot-res-weighted) shows the results. The weightings
are fairly successful at reconciling the overall size of effects from siblings
and children regressions. Among weighted scores that are significant (at p <
0.05/33) in either regression, `r sum(chn_larger)` estimates are
higher for children and `r length(chn_larger) - sum(chn_larger)` are
lower. However, some estimates differ widely or change
sign across the generations.


```{r plot-res-weighted, fig.cap = "Effects of polygenic scores on number of children/siblings. Regressions weighted by sex, age and education."}

res_weighted_all %>% 
      rename(
        "Dependent variable" = dep.var, 
      ) %>% 
      filter(reg.type == "weighted") %>% 
      standard_ggplot(fill = `Dependent variable`, n_regs = 33, order_idx = 1, 
        shape = reg.type) + 
        scale_shape_manual(values = c(21, 4))

```



```{r calc-flb-weights}

drake::loadd(res_flb_weights)
drake::loadd(res_sex)
res_flb_all <- left_join(
        res_flb_weights, 
        res_sex %>% filter(sex=="Female") %>% select(-subset, -sex), 
        by = "term", 
        suffix = c(".wt", ".nowt")
      ) %>% 
      mutate(prop_estimate = estimate.wt/estimate.nowt)

prop_wt_nowt <- mean(res_flb_all$prop_estimate)
pct_change_score <- function (score) {
  100 * (res_flb_all$prop_estimate[res_flb_all$term == score] - 1)
}
```


We also weighted data for women with children only, by age, education and age 
at first live birth.  Figure \@ref(fig:plot-flb-weights) 
shows the results. There 
are large changes for some variables, including EA3 
(`r pct_change_score("EA3_excl_23andMe_UK")` per cent), cognitive
ability (`r pct_change_score("cognitive_ability")` per cent) and
waist-hip ratio (WHR; `r pct_change_score("whr_combined")` percent).


Overall, these results suggest that previous work may have underestimated the level of
selection occurring in the population. [TODO: who?]


```{r plot-flb-weights, fig.cap = "Effect sizes on number of children, female respondents weighted by age at first live birth"}
  
bind_rows(
        Weighted   = res_flb_weights, 
        Unweighted = res_sex %>% filter(sex == "Female") %>% select(-subset, -sex),
        .id        = "Regression"
      ) %>% 
      standard_ggplot(Regression, n_regs = 66)
```


## Mechanisms behind natural selection

Why are selection effects *oppositely* signed in certain subgroups -- for
example, in older and younger mothers (by age at first live birth) or in those
with more and fewer lifetime sexual partners? A possible answer is given by the
economic theory of fertility [TODO cite Becker 1960]. According to this,
increases in potential earned income affect fertility via two opposing channels.
There is an "income effect" by which children become more affordable, like any
other good. Since childrearing has a cost in time, there is also a substitution
effect: the opportunity cost of childrearing increases if one's market wage is
higher. The income effect would lead higher earners to have more children. The
substitution effect would lead higher earners to have fewer children. It is
often assumed that the substitution effect will dominate for lone parents, since
they have less opportunity to share childcare responsibilities, while the income
effect will dominate for couples who are able to reap the gains from
specialization.

If so, then genetic characteristics which affect one's earnings potential in the
labour market may lead to opposing effects on fertility. Genetic
variants which improve one's earnings may increase fertility among couples, but
decrease fertility among single parents.

This explanation predicts that the strength of polygenic scores' effects on
fertility will correlate with the strength of their relationship with earnings.
We measure the correlation of each PGS with household income, as well as with
education level, a phenotypic variable which is likely to predict earnings. We
then relate these measurements to effect sizes on number of children.
Across scores, there is a clear negative relationship between effect on
fertility, and the correlation with income and/or education (Figure \@ref(fig:plot-cors-income-educ).


```{r plot-cors-income-educ, fig.cap="Effect sizes on number of children and correlations with income and education"}

drake::loadd(res_all)
cors_income <- cor(famhist[c(score_names)], famhist$income_cat, use = "pairwise")
# TODO: use age_left_edu when this includes college
cors_educ <-   cor(famhist[c(score_names)], famhist$edu_qual, use = "pairwise")

effect_size <- res_all %>% 
      filter(dep.var == "N children", reg.type == "raw") %>% 
      pull(estimate)

dfr <- data.frame(
      type = rep(c("Cor. with income", "Cor. with educ"), each = 33),
      cor = c(cors_income[,1], cors_educ[,1]),
      effect_size = rep(effect_size, 2)
)

ggplot(dfr, aes(effect_size, cor, colour = type)) + 
      geom_point() +
      facet_wrap(vars(type)) + 
      my_vline + 
      my_hline +
      labs(x = "Effect on n children", y = "Correlation") +
      scale_colour_manual(values = c("darkblue", "darkgreen")) +
      theme(legend.position = "none")

```


# Bits to integrate



```{r calc-corr-age-flb}

drake::loadd(res_age_flb)
drake::loadd(res_sex)

res_sex_comparison <- res_sex %>% 
      filter(sex == "Female") %>% 
      mutate(score_name = term) %>% 
      select(score_name, term, estimate:conf.high)

res_age_flb %<>% filter(term != "age_flb") 

res_combined <- bind_rows(
        raw      = res_sex_comparison, 
        with_age = res_age_flb %>% select(score_name, term, estimate:conf.high), 
        .id      = "reg.type"
      ) %>% 
      arrange(score_name)

raw_flb_comparison <- res_combined %>% 
      pivot_wider(
        id_cols     = score_name, 
        names_from  = reg.type, 
        values_from = estimate
      )

cor_raw_flb <- cor(raw_flb_comparison$raw, raw_flb_comparison$with_age)
opp_signed <- sum(
        sign(raw_flb_comparison$raw) != sign(raw_flb_comparison$with_age)
      )

```


Figure \@ref(fig:plot-age-flb) shows the results of *children* regressions for 
women only,
controlling for age at first live birth. Effect sizes are greatly reduced. Partly,
this is because the regressions exclude childless women. However,
in `r opp_signed` out of `r length(score_names)` cases, effect sizes actually
change sign with the controls. The correlation between effect sizes
controlling for age at first live birth, and raw effect sizes, is `r cor_raw_flb`.

```{r plot-age-flb, fig.cap = "Effect sizes on number of children, controlling for age at first live birth (women only). Effect sizes for women without controls are shown for comparison"}

n_regs <- as.double(nrow(res_age_flb))

res_combined %>% 
      mutate(
        score_name = pretty_names(score_name),
        score_name = fct_reorder(score_name, estimate, order_abs(2)),
        Regression = ifelse(reg.type == "raw", "Bivariate", "Controlled for age FLB")
      ) %>% 
      ggplot(aes(y = score_name, x = estimate, fill = Regression, 
        color = p.value < 0.05/{{n_regs}})) + 
        geom_vline(xintercept = 0, linetype = "dashed", color = "grey20") +
        pval_geom_point() +
        pval_scale() +
        scale_fill_brewer(type = "qual", palette = 3) +
        my_labs() +
        my_theme()
```


```{r calc-age-birth-parents}

drake::loadd(res_age_birth_parents)
drake::loadd(res_all)

res_sibs_raw <- filter(res_all, dep.var == "N siblings", reg.type == "raw")
compare_abp_raw <- res_age_birth_parents %>% 
      filter(! term %in% c("fath_age_birth", "moth_age_birth")) %>% 
      left_join(res_sibs_raw, by = "term")

cor_raw_fath <- with(
  compare_abp_raw %>% filter(control == "fath_age_birth"), 
  cor(estimate.x, estimate.y))
cor_raw_moth <- with(
  compare_abp_raw %>% filter(control == "moth_age_birth"), 
  cor(estimate.x, estimate.y))
```

We can run similar regressions for the parents' generation, using the subsets of respondents who reported their mother's or father's age
and who had no elder siblings. We run *sibling* regressions on these subsets,
controlling for either parent's age at their birth.
Figure \@ref(fig:plot-age-birth-parents) shows
the results. Effect sizes are very similar, whether controlling for
father's or mother's age at respondent's birth or mother's age at respondent's birth. Unlike for the respondents' generation, effect sizes are positively correlated with
the effect sizes from bivariate regressions (father's age at birth: 
$\rho$ `r cor_raw_fath`; mother's age at birth: $\rho$ `r cor_raw_moth`).


```{r plot-age-birth-parents, fig.cap = "Effect sizes on number of siblings controlling for parents' age at birth, eldest siblings"}


n_regs <- as.double(nrow(res_age_birth_parents)/2)

res_age_birth_parents %>% 
    filter(! term %in% c("fath_age_birth", "moth_age_birth")) %>% 
    mutate(
      term    = pretty_names(term),
      term    = fct_reorder(term, estimate, order_abs(2)),
      Control = ifelse(control == "fath_age_birth", 
                  "Father's age at birth", 
                  "Mother's age at birth"
                )
    ) %>% 
    ggplot(aes(y = term, x = estimate, fill = Control, 
      colour = p.value < 0.05/{{n_regs}})) + 
      pval_geom_point(alpha = 0.8) +  
      my_vline +
      my_fill_scale(2) +
      pval_scale() +
      my_labs()

```


```{r calc-age-flb-dv}

drake::loadd(res_age_flb_dv)
drake::loadd(res_age_birth_parents_dv)

compare_flb_dv <- left_join(
        res_age_flb_dv           %>% select(term, estimate),
        res_age_birth_parents_dv %>% select(term, estimate, dep.var),
        by = "term"
      )

cor_flb_fath <- with(compare_flb_dv %>% filter(dep.var == "fath_age_birth"),
        cor(estimate.x, estimate.y)
      )
cor_flb_moth <- with(compare_flb_dv %>% filter(dep.var == "moth_age_birth"),
        cor(estimate.x, estimate.y)
      )
```


These results suggest that polygenic scores may directly correlate with
age at first live birth. Figure \@ref(fig:plot-age-flb-dv) plots
estimated effect sizes from bivariate regressions for respondents, and
Figure \@ref(fig:plot-age-birth-parents-dv) does the same for their parents. 
Effect sizes are reasonably large. They are also very highly correlated across 
generations. Effect sizes of PGS on father's age at own birth, and on own age
at first live birth, have a correlation of `r cor_flb_fath`; for mother's age
and own age it is `r cor_flb_moth`


```{r plot-age-flb-dv, fig.cap = "Effects of polygenic scores on age at first live birth"}

n_regs <- as.double(nrow(res_age_flb_dv))

res_age_flb_dv %>% 
      mutate(
        term = pretty_names(term),
        term = fct_reorder(term, estimate, order_abs(1))
      ) %>% 
      ggplot(aes(estimate, term, colour = p.value < 0.05 / {{n_regs}})) + 
      my_vline +
      pval_geom_point(fill = "steelblue4") +
      pval_scale() + 
      my_labs() +
      my_theme()

```


```{r plot-age-birth-parents-dv, fig.cap = "Effects of polygenic scores on parents' age at own birth, eldest siblings"}

n_regs <- as.double(nrow(res_age_birth_parents_dv))

res_age_birth_parents_dv %>% 
      mutate(
        term = pretty_names(term),
        term = fct_reorder(term, estimate, order_abs(1)),
        "Dependent variable" = dplyr::recode(dep.var, 
          "fath_age_birth" = "Father's age", 
          "moth_age_birth" = "Mother's age"
        )
      ) %>% 
      ggplot(aes(estimate, term, fill = `Dependent variable`, 
        colour = p.value < 0.05 / {{n_regs}})) + 
        my_vline +
        pval_geom_point() +
        pval_scale() +
        my_fill_scale(n = 2) +
        my_labs()

```


# Appendix

## Controlling for principal components

Polygenic scores could capture effects that are really due to population 
stratification, although would not change our results for natural selection of
the scores. In \@ref(fig:plot-regs-controlled) we show results for selection on
polygenic scores residualized for the top 100 principal components of the
genetic data, calculated within the UK Biobank population. (TODO Abdel details.)



```{r calc-regs-controlled}

drake::loadd(res_all)

res_all_controlled <- res_all %>% 
  select(reg.type, dep.var, term, estimate) %>% 
  pivot_wider(names_from = c(reg.type, dep.var), values_from = estimate) %>% 
  mutate(
    consistent = sign(`raw_N siblings`) == sign(`raw_N children`) &
                 sign(`raw_N siblings`) == sign(`controlled_N siblings`) &
                 sign(`raw_N siblings`) == sign(`controlled_N children`)
  )

n_pgs  <- as.double(nrow(res_all_controlled))
prop_consistent_controlled <- mean(res_all_controlled$consistent)
controlled_smaller_sibs <- abs(res_all_controlled[["controlled_N siblings"]]) < 
  abs(res_all_controlled[["raw_N siblings"]])
controlled_smaller_children <- abs(res_all_controlled[["controlled_N children"]]) < 
  abs(res_all_controlled[["raw_N children"]])
median_prop_sibs <- median(abs(res_all_controlled[["controlled_N siblings"]]) /
    abs(res_all_controlled[["raw_N siblings"]]))
median_prop_children <- median(abs(res_all_controlled[["controlled_N children"]]) /
    abs(res_all_controlled[["raw_N children"]]))

```



In siblings regressions, effect sizes are smaller when residualizing for
principal components -- sometimes much smaller, as in the case of height. 
`r sum(controlled_smaller_sibs)` out of `r n_pgs` "controlled" effect sizes have 
a smaller absolute value than the corresponding "raw" effect size. The median
proportion between raw and controlled effect sizes is `r median_prop_sibs`.
Among the children regressions, this no longer holds. Effect sizes are barely
affected by controlling for principal components. 

Overall, `r prop_consistent_controlled * 100` per cent of effect sizes are
consistently signed across all four regressions (on children and siblings, and
with and without residualization).


```{r plot-regs-controlled, fig.cap = "Effects of residualized polygenic scores on number of siblings/children."}

drake::loadd(res_all)

n_regs <- as.double(nrow(res_all))
res_all %>% 
      mutate(
        term    = pretty_names(term),
        term    = reorder_within(term, estimate, dep.var, order_abs(1)),
        dep.var = fct_inorder(dep.var) 
      ) %>% 
      ggplot(aes(y = term, x = estimate, fill = reg.type, 
        colour = p.value < 0.05/{{n_regs}})) +
        my_vline + 
        facet_wrap(vars(dep.var), scales = "free_y") +
        pval_geom_point(position = position_dodge(0.4)) +
        my_labs() +
        pval_scale() +
        my_fill_scale(n = 2, guide = guide_legend(title = "")) +
        my_theme() +
        scale_y_reordered()

```


```{r}
drake::loadd(res_pcs)
n_regs <- as.double(nrow(res_pcs))
prop_sig <- res_pcs %>% 
      group_by(dep.var) %>% 
      summarize(sig = sum(p.value <= 0.05/nrow(res_pcs))) %>% 
      pull(sig, name = dep.var)
```


To get a further insight into this we regress *siblings* and *children* on
individual principal components. As Figure \@ref(fig:plot-pc-regs)
shows, effects are larger and more significant in siblings regressions. 
`r prop_sig[["N siblings"]]` principal components significantly predicted number of
siblings, while only `r prop_sig[["N children"]]` significantly predicted number
of children.


```{r plot-pc-regs, fig.cap = "Effect of principal components of genetic data on number of siblings/children. Absolute effect sizes are plotted. Each dot represents one bivariate regression. Points are jittered on the Y axis.", fig.height = 2}

res_pcs %>% 
      mutate(
        estimate = abs(estimate),
        dep.var  = fct_relevel(dep.var, "N children")
      ) %>% 
      ggplot(aes(estimate, dep.var, colour = p.value < 0.05/{{n_regs}})) + 
        geom_jitter(height = 0.15, width = 0, alpha = 0.9) + 
        scale_x_log10(labels = scales::label_number(accuracy = 0.0001)) +
        labs(x = "Effect size (log scale)", y = "") + 
        pval_scale(aesthetics = "colour")
        

```



## Selection over time


```{r calc-period-regs}

drake::loadd(res_period)
res_period %<>% 
      tidyr::extract(term, c("period", "score_name"),
        regex="year_split(.*):(.*)")
n_tests <- nrow(res_period)/2


summary_period <- res_period %>% 
      select(-std.error, -statistic) %>% 
      pivot_wider(
        names_from  = period, 
        values_from = c(estimate, conf.low, conf.high, p.value)
      ) %>% 
      group_by(score_name, children) %>% 
      mutate(
        significant = diff.p.value < 0.05/n_tests,
        sign_early  = sign(estimate_early),
        sign_late   = sign(estimate_late),
        size_inc    = abs(estimate_early) < abs(estimate_late),
        change_sign = sign_early != sign_late,
        Change      = case_when(
                        ! significant ~ "Insignificant",
                        change_sign   ~ "Change sign",
                        size_inc      ~ "Size increasing",
                        ! size_inc    ~ "Size decreasing"
                      )
      ) %>% 
      select(score_name, children, Change, significant, change_sign, 
        sign_early, sign_late) %>% 
      mutate(children = ifelse(children, "Respondents", "Parents")) %>% 
      pivot_wider(names_from = children, 
        values_from = c(Change, significant, change_sign, sign_early, 
        sign_late)) %>% 
      mutate(overall = case_when(
              ! change_sign_Parents & ! change_sign_Respondents & 
                sign_late_Parents == sign_early_Parents ~ 
                "Consistent",
              TRUE ~ "Changes direction"
            ))



```


To check whether effect sizes were changing over time, we ran regressions 
interacting PGS with birth year, median split at 1950. 
Tables \@ref(tab:tbl-siblings-by-period) and \@ref(tab:tbl-children-by-period)
summarize the results. Very few scores are significantly different. Only
one score, EA3, changes significantly across time in both generations: the
absolute size of the (negative) effect significantly increases in sibling 
regressions, and significantly decreases in children regressions.


```{r tbl-siblings-by-period}

period_table <- function (tbl, caption) {
  tbl %>% 
      as_hux() %>%
      set_bold(1, everywhere) %>% 
      set_bottom_border(1, everywhere) %>% 
      
      add_footnote(glue("Significance is measured at p < 0.05/{n_tests}"), 
        border = 0.4, font_size = 8) %>% 
      set_contents(1, everywhere, 
        c("Change", "Number of scores")) %>% 
      set_right_border(final(1), 1, 0) %>% 
      set_top_padding(1) %>% 
      set_bottom_padding(1) %>%
      set_left_padding(everywhere, 1, 0) %>% 
      set_right_padding(everywhere, 2, 0) %>% 
      set_caption(caption) %>% 
      set_caption_width(1)
}

summary_period %>% 
      group_by(Change_Parents) %>% 
      count() %>% 
      period_table("Change in effect sizes between early and late born parents, 'sibling' regressions")
      
```



```{r tbl-children-by-period}
summary_period %>% 
      group_by(Change_Respondents) %>% 
      count() %>% 
      period_table("Change in effect sizes between early and late born respondents, 'children' regressions")
```







## Genetic correlations with EA3


Another way to examine the "earnings" theory of natural selection is to compare
effect sizes of PGS with their genetic correlation with educational attainment
(EA3). Since EA3 strongly predicts earnings, if earnings drives differences
in fertility, we'd expect a correlation between the two sets of results. Figure
\@ref(fig:plot-rgs-by-effect-size) shows this is so.

TODO: ref source of data.

```{r plot-rgs-by-effect-size, fig.cap = "Effect size on n siblings by genetic correlation with EA3"}

drake::loadd(rgs)
drake::loadd(res_all)

rgs <- left_join(rgs, 
        res_all %>% filter(reg.type == "raw", dep.var == "N children"), 
        by = c("p2" = "term"))

rgs %>% 
      filter(p2 != "EA3_excl_23andMe_UK", p2 != "EA2_noUKB") %>% 
      ggplot(aes(rg, estimate)) + 
        geom_point() +
        my_vline +
        my_hline +
        labs(x = "rG with EA3", y = "Effect on number of children")
          
```

```{r correlate-effect-sizes, eval = FALSE}
combined_results <- res %>% 
      mutate(PCs = ifelse(reg.type=="raw", "no", "yes")) %>% 
      dplyr::select(-reg.type) %>% 
      {bind_rows(bivariate = ., multivariate = all_res, .id = "reg.type")} %>% 
      arrange(term, reg.type, PCs) %>% 
      dplyr::select(term, reg.type, PCs, estimate) %>% 
      pivot_wider(names_from = c(reg.type, PCs), values_from = estimate)

cor(combined_results[-1], use = "complete")

```


## Number of children


Figure \@ref(fig:plot-n-children-bar) shows the full distribution of number 
of children born for different ventiles of the EA3 polygenic score. The 
strongest relationship seems to be for having 0 children versus 1 or more.


```{r plot-n-children-bar, fig.cap = "Number of children by ventiles of EA3 PGS"}
famhist %>% 
      select(n_children, EA3_excl_23andMe_UK, sex) %>% 
      mutate(
        "EA3 Ventile" = chop_equally(EA3_excl_23andMe_UK, 20, labels = 1:20),
        "N Children"  = santoku::chop(n_children, 0:4, labels = c(0:3, "4+")),
        Sex           = factor(sex, levels = 0:1, labels = c("Female", "Male"))
        ) %>% 
      filter(! is.na(`EA3 Ventile`), ! is.na(`N Children`)) %>% 
      ggplot(aes(`EA3 Ventile`, fill = `N Children`, group = `N Children`)) + 
        geom_bar(position = position_fill(reverse = TRUE), alpha = 0.7) + 
        facet_wrap(vars(Sex)) +
        scale_fill_viridis_d(option = "A") +
        scale_y_continuous(n.breaks = 10, labels = scales::percent) +
        theme(legend.position = "bottom")


```


## Causality


Different polygenic scores are correlated. Table \@ref(tab:tbl-pgs-corrs) shows the top
correlations in the sample. Because of this, bivariate correlations between
PGS and number of children might be driven by other genetic scores. To explore which polygenic scores are driving negative selection, we run a single
omnibus regression of *number of children* on all the PGS. We exclude EA2, 
waist-hip ratio, waist-circumference, and "Hip combined" since they are 
highly correlated with other scores, which could make our estimates unstable. Figure \@ref(fig:plot-together) shows the results. Interestingly, several PGS remain independently significant, although effect sizes are reduced.


```{r tbl-pgs-corrs}
cor_tbl <- cor(famhist[score_names], use = "pair") %>% 
      as_tibble() %>% 
      mutate(score_name = score_names, .before = 1) %>% 
      pivot_longer(cols = -score_name, values_to = "Correlation") %>% 
      filter(score_name < name) %>% 
      arrange(desc(Correlation)) %>% 
      slice(1:10) %>% 
      mutate(across(c(score_name, name), pretty_names)) 

as_hux(cor_tbl, add_colnames = TRUE) %>% 
      set_contents(1, 1:2, c("PGS", "PGS")) %>% 
      theme_basic(header_col = FALSE) %>% 
      set_bottom_border(1, everywhere, 0.4) %>% 
      set_bottom_border(final(1), everywhere, 0.4) %>% 
      set_tb_padding(4) %>% 
      set_caption("Top 10 correlations between polygenic scores")

```



```{r plot-together, fig.cap = "Partial correlations with number of children"}

loadd(res_together)
n_regs <- as.double(nrow(res_together))
res_together %>% 
      mutate(
        term = pretty_names(term),
        dep.var = dplyr::recode(dep.var, 
          "n_children" = "N Children", "n_sibs" = "N Siblings"),
        dep.var = fct_relevel(dep.var, "N Siblings")
      ) %>% 
      ggplot(aes(y = reorder_within(term, estimate, dep.var, order_abs(1)), 
        x = estimate, color = p.value < 0.05/{{n_regs}}, fill  = PCs)) + 
        pval_geom_point(alpha = 0.8) +
        my_vline +
        facet_wrap(vars(dep.var), scales = "free_y") +
        pval_scale() +
        my_fill_scale(n = 2) +
        my_labs() + 
        scale_y_reordered() +
        theme(legend.position = "bottom")
```

